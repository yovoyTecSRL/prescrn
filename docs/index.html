<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Banco Validación - Solicitud de Tarjeta de Crédito</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/styles.css">
    <style>
    </style>

</head>
<body>
    <div class="banco-header">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Banco Logo" class="logo"/>
        <h1>Banco Validación</h1>
        
  <div class="bandera">
        <div class="franja azul"></div>
        <div class="franja blanco"></div>
        <div class="franja rojo"></div>
        <div class="franja blanco"></div>
        <div class="franja azul"></div>
  </div>
        <div class="sub">Solicita tu tarjeta de crédito en minutos</div>
    </div>

    
    <div class="nav" >
      <button onclick="ejecutarPruebasInteractivo()"
            class="button">
            Pruebas Automáticas
        </button>
        <a href="./pruebas-automaticas.html" class="button">Ver Pruebas</a>
        <a href="./reporte-pruebas.html" class="button">Ver Reportes</a>
    </div>

    <div class="container">
        <div class="tarjeta-demo">
            <div class="chip"></div>
            <div class="info">
                <span>Tarjeta de Crédito</span>
                <strong>Banco Validación</strong>
            </div>
            <img src="https://cdn-icons-png.flaticon.com/512/196/196578.png" alt="Visa" width="38"/>
        </div>
        <div class="chat" id="chat"></div>
        <form id="chatForm">
            <input type="text" id="input" placeholder="Escribe tu respuesta..." autocomplete="off" required />
            <button type="submit">Enviar</button>
        </form>
        <div id="estado-tarjeta" class="estado-tarjeta"></div>
    </div>
    <div class="footer">
        &copy; 2025 Banco Validación. Todos los derechos reservados.
    </div>
    <div style="text-align:center; margin-top:24px;">
        
        <div id="resultados-pruebas" style="margin-top:18px; color:#222; font-size:1.05em;"></div>
    </div>
    <script>
        let datos = {};
        let paso = 1;
        let validando = null;
        let esperando_confirmacion = false;
        let esperando_nueva_direccion = false;
        const chat = document.getElementById('chat');
        const form = document.getElementById('chatForm');
        const input = document.getElementById('input');

        function agregarMensaje(texto, clase) {
            const div = document.createElement('div');
            div.className = clase;
            div.textContent = texto;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function reproducirSonido() {
            const audio = new Audio('https://cdn.pixabay.com/audio/2022/07/26/audio_124bfa4c82.mp3');
            audio.play();
        }

        function hablar(texto) {
            if ('speechSynthesis' in window) {
                const utter = new SpeechSynthesisUtterance(texto);
                utter.lang = 'es-ES';
                window.speechSynthesis.speak(utter);
            }
        }

        function enviarDatos() {
            fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...datos, paso, validando })
            })
            .then(res => res.json())
            .then(respuesta => {
                if (respuesta.pregunta) {
                    agregarMensaje('Banco: ' + respuesta.pregunta, 'bot');
                    paso = respuesta.paso;
                    validando = null;
                } else if (respuesta.validando) {
                    agregarMensaje('Banco: ' + respuesta.mensaje, 'bot');
                    validando = respuesta.siguiente;
                    setTimeout(enviarDatos, 1200);
                } else if (respuesta.pregunta_final) {
                    agregarMensaje('Banco: ' + respuesta.mensaje, 'bot');
                    esperando_confirmacion = true;
                } else if (respuesta.pide_nueva_direccion) {
                    agregarMensaje('Banco: ' + respuesta.mensaje, 'bot');
                    esperando_nueva_direccion = true;
                } else if (respuesta.orden_creada) {
                    agregarMensaje('Banco: ' + respuesta.mensaje, 'bot');
                    reproducirSonido();
                    setTimeout(() => {
                        hablar(`¡Felicidades! Clasificaste para una tarjeta de crédito. La orden de entrega fue creada y te llegará en las próximas 48 horas a la dirección indicada. Tu número de solicitud es: ${respuesta.numeroSolicitud}.`);
                    }, 1200);
                    form.style.display = 'none';
                    mostrarBotonEstado(respuesta.numeroSolicitud, datos.direccion);
                }
            });
        }

        function enviarDatosExtra(extra) {
            fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...datos, ...extra, paso, validando })
            })
            .then(res => res.json())
            .then(respuesta => {
                if (respuesta.pregunta_final) {
                    agregarMensaje('Banco: ' + respuesta.mensaje, 'bot');
                    esperando_confirmacion = true;
                } else if (respuesta.pide_nueva_direccion) {
                    agregarMensaje('Banco: ' + respuesta.mensaje, 'bot');
                    esperando_nueva_direccion = true;
                } else if (respuesta.orden_creada) {
                    agregarMensaje('Banco: ' + respuesta.mensaje, 'bot');
                    reproducirSonido();
                    setTimeout(() => {
                        hablar(`¡Felicidades! Clasificaste para una tarjeta de crédito. La orden de entrega fue creada y te llegará en las próximas 48 horas a la dirección indicada. Tu número de solicitud es: ${respuesta.numeroSolicitud}.`);
                    }, 1200);
                    form.style.display = 'none';
                    mostrarBotonEstado(respuesta.numeroSolicitud, datos.direccion);
                }
            });
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const valor = input.value.trim();
            if (!valor) return;
            agregarMensaje('Tú: ' + valor, 'user');
            input.value = '';

            // Manejo de la confirmación de dirección
            if (esperando_confirmacion) {
                esperando_confirmacion = false;
                if (valor.toLowerCase() === "si" || valor.toLowerCase() === "sí") {
                    enviarDatosExtra({ direccion_confirmada: "si" });
                } else {
                    esperando_nueva_direccion = true;
                    enviarDatosExtra({ direccion_confirmada: "no" });
                }
                return;
            }
            // Manejo de la nueva dirección
            if (esperando_nueva_direccion) {
                esperando_nueva_direccion = false;
                enviarDatosExtra({ nueva_direccion: valor });
                return;
            }

            switch (paso) {
                case 1: datos.nombre = valor; break;
                case 2: datos.cedula = valor; break;
                case 3: datos.telefono = valor; break;
                case 4: datos.direccion = valor; break;
            }
            paso++;
            enviarDatos();
        });

        // Iniciar chat
        agregarMensaje('Banco: ¡Bienvenido! Vamos a solicitar tu tarjeta de crédito. ¿Cuál es tu nombre completo?', 'bot');

        function randomNombre() {
            const nombres = ["Ana", "Luis", "Carlos", "María", "Pedro", "Lucía", "Jorge", "Sofía", "Miguel", "Valeria"];
            const apellidos = ["Pérez", "García", "Rodríguez", "López", "Martínez", "Sánchez", "Ramírez", "Cruz", "Flores", "Morales"];
            return nombres[Math.floor(Math.random()*nombres.length)] + " " + apellidos[Math.floor(Math.random()*apellidos.length)];
        }
        function randomCedula() {
            return Math.floor(100000000 + Math.random() * 900000000).toString();
        }
        function randomTelefono() {
            return "8" + Math.floor(10000000 + Math.random() * 9000000).toString();
        }
        function randomDireccion() {
            const lugares = ["San José", "Heredia", "Cartago", "Alajuela", "Puntarenas", "Limón", "Guanacaste"];
            return lugares[Math.floor(Math.random()*lugares.length)];
        }

        async function ejecutarPruebas() {
            const resultados = document.getElementById('resultados-pruebas');
            resultados.textContent = "Ejecutando pruebas automáticas...";
            let exitos = 0, fallos = 0, detalles = [];
            for(let i=1; i<=10; i++) {
                const nombre = randomNombre();
                const cedula = randomCedula();
                const telefono = randomTelefono();
                const direccion = randomDireccion();
                let paso = 1, validando = null, direccion_confirmada = null, nueva_direccion = null;
                let ok = true, msg = "";

                // Paso 1: nombre
                let r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paso:1})});
                r = await r.json();
                if(!r.pregunta) { ok=false; msg="No pregunta nombre"; }

                // Paso 2: cédula
                if(ok) {
                    r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, paso:2})});
                    r = await r.json();
                    if(!r.pregunta) { ok=false; msg="No pregunta cédula"; }
                }

                // Paso 3: teléfono
                if(ok) {
                    r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, paso:3})});
                    r = await r.json();
                    if(!r.pregunta) { ok=false; msg="No pregunta teléfono"; }
                }

                // Paso 4: dirección
                if(ok) {
                    r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, telefono, paso:4})});
                    r = await r.json();
                    if(!r.pregunta) { ok=false; msg="No pregunta dirección"; }
                }

                // Validaciones externas
                if(ok) {
                    r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, telefono, direccion})});
                    r = await r.json();
                    if(!r.validando) { ok=false; msg="No inicia validaciones externas"; }
                }
                const validaciones = ["PROTECTORA", "BCR", "HACIENDA", "FINAL"];
                for(let v of validaciones) {
                    if(ok) {
                        r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, telefono, direccion, validando:v})});
                        r = await r.json();
                        if(v !== "FINAL" && !r.validando) { ok=false; msg=`No valida ${v}`; }
                        if(v === "FINAL" && !r.pregunta_final) { ok=false; msg="No pregunta confirmación de dirección"; }
                    }
                }

                // Confirmación de dirección (aleatorio sí/no)
                let confirma = Math.random() > 0.5 ? "si" : "no";
                if(ok && confirma === "si") {
                    r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, telefono, direccion, direccion_confirmada:"si"})});
                    r = await r.json();
                    if(!r.orden_creada) { ok=false; msg="No crea orden con dirección original"; }
                }
                if(ok && confirma === "no") {
                    // Pide nueva dirección
                    r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, telefono, direccion, direccion_confirmada:"no"})});
                    r = await r.json();
                    if(!r.pide_nueva_direccion) { ok=false; msg="No pide nueva dirección"; }
                    // Envía nueva dirección
                    const nueva = randomDireccion();
                    r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, telefono, direccion, nueva_direccion:nueva})});
                    r = await r.json();
                    if(!r.orden_creada) { ok=false; msg="No crea orden con nueva dirección"; }
                }

                if(ok) {
                    exitos++;
                    detalles.push(`✔️ Prueba ${i}: OK`);
                } else {
                    fallos++;
                    detalles.push(`❌ Prueba ${i}: ${msg}`);
                }
            }
            resultados.innerHTML = `<b>Resultados de pruebas automáticas:</b><br>
                Éxitos: <span style="color:green">${exitos}</span> &nbsp; Fallos: <span style="color:red">${fallos}</span><br>
                <div style="text-align:left;max-width:400px;margin:10px auto;">${detalles.join('<br>')}</div>`;
        }

        async function ejecutarPruebasTandas(veces = 5) {
            const resultados = document.getElementById('resultados-pruebas');
            resultados.textContent = "Ejecutando pruebas automáticas...";
            let totalExitos = 0, totalFallos = 0, detalles = [];
            for(let tanda=1; tanda<=veces; tanda++) {
                let exitos = 0, fallos = 0, detallesTanda = [];
                for(let i=1; i<=10; i++) {
                    const nombre = randomNombre();
                    const cedula = randomCedula();
                    const telefono = randomTelefono();
                    const direccion = randomDireccion();
                    let paso = 1, validando = null, direccion_confirmada = null, nueva_direccion = null;
                    let ok = true, msg = "";

                    // Paso 1: nombre
                    let r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paso:1})});
                    r = await r.json();
                    if(!r.pregunta) { ok=false; msg="No pregunta nombre"; }

                    // Paso 2: cédula
                    if(ok) {
                        r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, paso:2})});
                        r = await r.json();
                        if(!r.pregunta) { ok=false; msg="No pregunta cédula"; }
                    }

                    // Paso 3: teléfono
                    if(ok) {
                        r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, paso:3})});
                        r = await r.json();
                        if(!r.pregunta) { ok=false; msg="No pregunta teléfono"; }
                    }

                    // Paso 4: dirección
                    if(ok) {
                        r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, telefono, paso:4})});
                        r = await r.json();
                        if(!r.pregunta) { ok=false; msg="No pregunta dirección"; }
                    }

                    // Validaciones externas
                    if(ok) {
                        r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, telefono, direccion})});
                        r = await r.json();
                        if(!r.validando) { ok=false; msg="No inicia validaciones externas"; }
                    }
                    const validaciones = ["PROTECTORA", "BCR", "HACIENDA", "FINAL"];
                    for(let v of validaciones) {
                        if(ok) {
                            r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, telefono, direccion, validando:v})});
                            r = await r.json();
                            if(v !== "FINAL" && !r.validando) { ok=false; msg=`No valida ${v}`; }
                            if(v === "FINAL" && !r.pregunta_final) { ok=false; msg="No pregunta confirmación de dirección"; }
                        }
                    }

                    // Confirmación de dirección (aleatorio sí/no)
                    let confirma = Math.random() > 0.5 ? "si" : "no";
                    if(ok && confirma === "si") {
                        r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, telefono, direccion, direccion_confirmada:"si"})});
                        r = await r.json();
                        if(!r.orden_creada) { ok=false; msg="No crea orden con dirección original"; }
                    }
                    if(ok && confirma === "no") {
                        // Pide nueva dirección
                        r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, telefono, direccion, direccion_confirmada:"no"})});
                        r = await r.json();
                        if(!r.pide_nueva_direccion) { ok=false; msg="No pide nueva dirección"; }
                        // Envía nueva dirección
                        const nueva = randomDireccion();
                        r = await fetch('/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre, cedula, telefono, direccion, nueva_direccion:nueva})});
                        r = await r.json();
                        if(!r.orden_creada) { ok=false; msg="No crea orden con nueva dirección"; }
                    }

                    if(ok) {
                        exitos++;
                        detallesTanda.push(`✔️ Tanda ${tanda} - Prueba ${i}: OK`);
                    } else {
                        fallos++;
                        detallesTanda.push(`❌ Tanda ${tanda} - Prueba ${i}: ${msg}`);
                    }
                }
                totalExitos += exitos;
                totalFallos += fallos;
                detalles = detalles.concat(detallesTanda);
            }
            resultados.innerHTML = `<b>Resultados de pruebas automáticas:</b><br>
                Éxitos: <span style="color:green">${totalExitos}</span> &nbsp; Fallos: <span style="color:red">${totalFallos}</span><br>
                <div style="text-align:left;max-width:400px;margin:10px auto;">${detalles.join('<br>')}</div>`;
        }

        let pruebasEnCurso = false;

        async function simularSolicitudAutomatica(num) {
            chat.innerHTML = '';
            form.style.display = 'none';
            agregarMensaje(`--- Prueba automática #${num} ---`, 'bot');
            await new Promise(r => setTimeout(r, 400));
            let nombre = randomNombre();
            agregarMensaje('Banco: ¿Cuál es tu nombre completo?', 'bot');
            await new Promise(r => setTimeout(r, 400));
            agregarMensaje('Tú: ' + nombre, 'user');
            await new Promise(r => setTimeout(r, 400));
            let cedula = randomCedula();
            agregarMensaje('Banco: ¿Cuál es tu cédula?', 'bot');
            await new Promise(r => setTimeout(r, 400));
            agregarMensaje('Tú: ' + cedula, 'user');
            await new Promise(r => setTimeout(r, 400));
            let telefono = randomTelefono();
            agregarMensaje('Banco: ¿Cuál es tu teléfono?', 'bot');
            await new Promise(r => setTimeout(r, 400));
            agregarMensaje('Tú: ' + telefono, 'user');
            await new Promise(r => setTimeout(r, 400));
            let direccion = randomDireccion();
            agregarMensaje('Banco: ¿Cuál es la dirección de entrega de la tarjeta?', 'bot');
            await new Promise(r => setTimeout(r, 400));
            agregarMensaje('Tú: ' + direccion, 'user');
            await new Promise(r => setTimeout(r, 400));
            agregarMensaje('Banco: Validando en CCSS...', 'bot');
            await new Promise(r => setTimeout(r, 300));
            agregarMensaje('Banco: Validando en Protectora de Crédito...', 'bot');
            await new Promise(r => setTimeout(r, 300));
            agregarMensaje('Banco: Validando en Banco de Costa Rica...', 'bot');
            await new Promise(r => setTimeout(r, 300));
            agregarMensaje('Banco: Validando en Ministerio de Hacienda...', 'bot');
            await new Promise(r => setTimeout(r, 300));
            agregarMensaje(`Banco: ¿La dirección de entrega es la misma que escribiste: "${direccion}"? (Responde sí o no)`, 'bot');
            await new Promise(r => setTimeout(r, 400));
            let confirma = Math.random() > 0.5 ? "sí" : "no";
            agregarMensaje('Tú: ' + confirma, 'user');
            await new Promise(r => setTimeout(r, 400));
            // Simula número de solicitud
            const numeroSolicitud = Math.floor(100000 + Math.random() * 900000);
            agregarMensaje(`Banco: ¡Felicidades! Clasificaste para una tarjeta de crédito. La orden de entrega fue creada y te llegará en las próximas 48 horas a: "${direccion}". Tu número de solicitud es: ${numeroSolicitud}.`, 'bot');
            reproducirSonido();
            setTimeout(() => {
                hablar(`¡Felicidades! Clasificaste para una tarjeta de crédito. La orden de entrega fue creada y te llegará en las próximas 48 horas a la dirección indicada. Tu número de solicitud es: ${numeroSolicitud}.`);
            }, 1200);
            await new Promise(r => setTimeout(r, 2000));
            form.style.display = '';
        }

        async function ejecutarPruebasInteractivo() {
            if (pruebasEnCurso) return;
            pruebasEnCurso = true;
            const resultados = document.getElementById('resultados-pruebas');
            resultados.textContent = "Ejecutando 50 pruebas automáticas visuales...";
            for(let tanda=1; tanda<=5; tanda++) {
                for(let i=1; i<=10; i++) {
                    resultados.textContent = `Ejecutando prueba ${(tanda-1)*10+i} de 50...`;
                    await simularSolicitudAutomatica((tanda-1)*10+i);
                }
            }
            resultados.innerHTML = `<b>¡Pruebas automáticas completadas!</b>`;
            pruebasEnCurso = false;
        }

        function mostrarBotonEstado(numeroSolicitud, direccion) {
            const estadoDiv = document.getElementById('estado-tarjeta');
            estadoDiv.style.display = 'block';
            estadoDiv.innerHTML = `
                <b>¡Solicitud aceptada!</b><br>
                Tu tarjeta está en proceso y será entregada en máximo <b>48 horas</b> en:<br>
                <span style="color:#ce1126">${direccion}</span><br>
                <b>Número de solicitud:</b> <span style="color:#002b7f">${numeroSolicitud}</span><br><br>
                <button onclick="verEstadoTarjeta('${numeroSolicitud}')" style="background:#ce1126;color:#fff;padding:8px 18px;border:none;border-radius:6px;font-size:1em;cursor:pointer;">
                    Ver estado de mi tarjeta
                </button>
                <div id="estado-resultado" style="margin-top:12px;"></div>
            `;
        }

        function verEstadoTarjeta(numeroSolicitud) {
            // Simulación de estado (puedes conectar a backend real después)
            const estados = [
                "En proceso en el banco",
                "En ruta de entrega",
                "Listo para entregar",
                "Entregado"
            ];
            const estado = estados[Math.floor(Math.random()*estados.length)];
            document.getElementById('estado-resultado').innerHTML =
                `<b>Estado actual:</b> <span style="color:#1565c0">${estado}</span><br>
                <small>Número de solicitud: ${numeroSolicitud}</small>`;
        }

        window.addEventListener('DOMContentLoaded', () => {
            ejecutarPruebasTandas(5); // Ejecuta 5 tandas de 10 pruebas cada una (total 50)
        });
    </script>
</body>
</html>