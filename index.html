<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Banco Validación - Solicitud de Tarjeta de Crédito</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/styles.css">
    <style>
    </style>

</head>
<body>
    <div class="banco-header">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Banco Logo" class="logo"/>
        <h1>Banco Validación</h1>
        
  <div class="bandera">
        <div class="franja azul"></div>
        <div class="franja blanco"></div>
        <div class="franja rojo"></div>
        <div class="franja blanco"></div>
        <div class="franja azul"></div>
  </div>
        <div class="sub">Solicita tu tarjeta de crédito en minutos</div>
    </div>

    
    <div class="nav" >
      <button onclick="ejecutarPruebasInteractivo()"
            class="button">
            Pruebas Automáticas
        </button>
        <a href="./pruebas-automaticas.html" class="button">Ver Pruebas</a>
        <a href="./reporte-pruebas.html" class="button">Ver Reportes</a>
    </div>

    <div class="container">
        <div class="tarjeta-demo">
            <div class="chip"></div>
            <div class="info">
                <span>Tarjeta de Crédito</span>
                <strong>Banco Validación</strong>
            </div>
            <img src="https://cdn-icons-png.flaticon.com/512/196/196578.png" alt="Visa" width="38"/>
        </div>
        <div class="chat" id="chat"></div>
        <form id="chatForm">
            <input type="text" id="input" placeholder="Escribe tu respuesta..." autocomplete="off" required />
            <button type="submit">Enviar</button>
        </form>
        <div id="estado-tarjeta" class="estado-tarjeta"></div>
    </div>
    <div class="footer">
        &copy; 2025 Banco Validación. Todos los derechos reservados.
    </div>
    <div style="text-align:center; margin-top:24px;">
        
        <div id="resultados-pruebas" style="margin-top:18px; color:#222; font-size:1.05em;"></div>
    </div>
   
    <script >
        document.addEventListener("DOMContentLoaded", () => {
    const chat = document.getElementById("chat");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("input");
    let paso = 1;
    let datos = {};
    let validando = null;
    let esperando_confirmacion = false;
    let esperando_nueva_direccion = false;

    function agregarMensaje(texto, clase) {
        const div = document.createElement("div");
        div.className = clase;
        div.textContent = texto;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function reproducirSonido() {
        const audio = new Audio('https://cdn.pixabay.com/audio/2022/07/26/audio_124bfa4c82.mp3');
        audio.play();
    }

    function hablar(texto) {
        if ('speechSynthesis' in window) {
            const utter = new SpeechSynthesisUtterance(texto);
            utter.lang = 'es-ES';
            window.speechSynthesis.speak(utter);
        }
    }

    function responder(data) {
        if (paso === 1) {
            if (!data.nombre) return { paso: 1, pregunta: "¿Cuál es tu nombre completo?" };
            return { paso: 2, pregunta: "¿Cuál es tu cédula?" };
        }

        if (paso === 2) {
            if (!data.cedula) return { paso: 2, pregunta: "¿Cuál es tu cédula?" };
            return { paso: 3, pregunta: "¿Cuál es tu teléfono?" };
        }

        if (paso === 3) {
            if (!data.telefono) return { paso: 3, pregunta: "¿Cuál es tu teléfono?" };
            return { paso: 4, pregunta: "¿Cuál es la dirección de entrega de la tarjeta?" };
        }

        if (paso === 4) {
            if (!data.direccion) return { paso: 4, pregunta: "¿Cuál es la dirección de entrega de la tarjeta?" };
            return { validando: true, mensaje: "Validando en CCSS...", siguiente: "PROTECTORA" };
        }

        if (validando === "PROTECTORA") {
            return { validando: true, mensaje: "Validando en Protectora de Crédito...", siguiente: "BCR" };
        }

        if (validando === "BCR") {
            return { validando: true, mensaje: "Validando en Banco de Costa Rica...", siguiente: "HACIENDA" };
        }

        if (validando === "HACIENDA") {
            return { validando: true, mensaje: "Validando en Ministerio de Hacienda...", siguiente: "FINAL" };
        }

        if (validando === "FINAL") {
            validando = null; // rompe el ciclo
            return {
                pregunta_final: true,
                mensaje: `¿La dirección de entrega es la misma que escribiste: "${datos.direccion}"? (Responde sí o no)`
            };
        }

        if (data.direccion_confirmada === "si") {
            const numero = Math.floor(100000 + Math.random() * 900000);
            return {
                orden_creada: true,
                mensaje: `¡Felicidades! Clasificaste para una tarjeta. Tu número de solicitud es: ${numero}.`,
                numeroSolicitud: numero
            };
        }

        if (data.direccion_confirmada === "no") {
            esperando_nueva_direccion = true;
            return {
                pide_nueva_direccion: true,
                mensaje: "Por favor, indícanos tu nueva dirección de entrega."
            };
        }

        if (data.nueva_direccion) {
            const numero = Math.floor(100000 + Math.random() * 900000);
            datos.direccion = data.nueva_direccion;
            return {
                orden_creada: true,
                mensaje: `¡Gracias! Enviaremos tu tarjeta a: "${data.nueva_direccion}". Tu número de solicitud es: ${numero}.`,
                numeroSolicitud: numero
            };
        }

        return { mensaje: "Algo salió mal..." };
    }

    function procesarRespuesta(r) {
        if (r.pregunta) {
            agregarMensaje("Banco: " + r.pregunta, "bot");
        }
        if (r.pregunta_final) {
            agregarMensaje("Banco: " + r.mensaje, "bot");
            esperando_confirmacion = true;
        }
        if (r.pide_nueva_direccion) {
            agregarMensaje("Banco: " + r.mensaje, "bot");
            esperando_nueva_direccion = true;
        }
        if (r.orden_creada) {
            agregarMensaje("Banco: " + r.mensaje, "bot");
            reproducirSonido();
            setTimeout(() => {
                hablar(r.mensaje);
            }, 800);
            form.style.display = "none";
        }
    }

    async function iniciarValidaciones() {
        while (validando) {
            const r = responder(datos);

            if (!r.validando) {
                procesarRespuesta(r);
                break;
            }

            agregarMensaje("Banco: " + r.mensaje, "bot");
            await new Promise(resolve => setTimeout(resolve, 1000));
            validando = r.siguiente;
        }
    }

    form.addEventListener("submit", function (e) {
        e.preventDefault();
        const valor = input.value.trim();
        if (!valor) return;
        agregarMensaje("Tú: " + valor, "user");
        input.value = "";

        if (esperando_confirmacion) {
            esperando_confirmacion = false;
            const r = responder({ direccion_confirmada: valor.toLowerCase() });
            procesarRespuesta(r);
            return;
        }

        if (esperando_nueva_direccion) {
            esperando_nueva_direccion = false;
            const r = responder({ nueva_direccion: valor });
            procesarRespuesta(r);
            return;
        }

        switch (paso) {
            case 1: datos.nombre = valor; break;
            case 2: datos.cedula = valor; break;
            case 3: datos.telefono = valor; break;
            case 4: datos.direccion = valor; break;
        }

        const r = responder(datos);
        paso = r.paso || paso;

        if (r.validando) {
            validando = r.siguiente;
            iniciarValidaciones(); // async loop sin loops infinitos
        } else {
            procesarRespuesta(r);
        }
    });

    agregarMensaje("Banco: ¡Bienvenido! Vamos a solicitar tu tarjeta de crédito. ¿Cuál es tu nombre completo?", "bot");
});


    </script>
</body>
</html>